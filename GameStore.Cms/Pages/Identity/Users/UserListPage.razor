@page "/users"
@attribute [Authorize(Policies.Identity)]

@inherits BaseDataPage<ODataUser>
@inject UserODataService UserODataService
@inject UserService UserService

<div class="row">
    <div class="col-xl-3">
        <RadzenButton Icon="add" Click=@(async args => await DialogService.OpenAsync<UserAddPage>("Yeni Kullanıcı",
                          null,
                          new DialogOptions{Width = "600px"} )) />

        <RadzenButton Icon="refresh" Click=@Refresh />

        @if (SelectedItem != null)
        {
            <RadzenButton Icon="edit" Click=@(async args => await DialogService.OpenAsync<UserUpdatePage>("Kullanıcı Düzenle",
                          new Dictionary<string, object> { { "UserId", SelectedItem.Id } },
                          new DialogOptions{Width = "600px"})) />
            <RadzenButton Icon="remove" Click=@DeleteAsync />

            <RadzenButton Icon="key" Click=@(async args => await DialogService.OpenAsync<UserPermissionsPage>(SelectedItem.FirstName,
                            new Dictionary<string, object> { { "User", SelectedItem } },
                            new DialogOptions{Width = "700px"})) />

            <RadzenButton Icon="badge" Click=@(async args => await DialogService.OpenAsync<UserRolesPage>(SelectedItem.FirstName,
                            new Dictionary<string, object> { { "User", SelectedItem } },
                            new DialogOptions{Width = "700px"})) />
        }


    </div>
</div>



<BaseDataGrid TItem="ODataUser"
              IsLoading="IsLoading"
              Data="Data"
              @bind-SelectedItem="@SelectedItem"
              LoadData="LoadData"
              Count="Count"
              Columns=@(new Dictionary<string, string>
              {
                  { "FirstName", "İsim" },
                  { "LastName", "Soy İsim" },
                  { "UserName", "Kulanıcı Adı" },
                  { "CreateDate", "Oluşturulma Tarihi" },
                  { "EditDate", "Son Güncellenme Tarihi" }
              }) />

@code {
    protected override async Task LoadData(LoadDataArgs args)
    {
        IsLoading = true;
        LastArgs = args;

        var result = await UserODataService.GetListAsync(new ODataRequestParams
        {
            Count = true,
            Filter = args.Filter,
            OrderBy = args.OrderBy,
            Skip = args.Skip,
            Top = args.Top
        });

        Data = result.Value.AsODataEnumerable();
        Count = result.Count;

        IsLoading = false;
        StateHasChanged();

    }

    private async void DeleteAsync()
    {
        var isConfirm = await DialogService.Confirm("Kullanıcıyı silmek istediğinizden emin misiniz?", "Uyarı", new ConfirmOptions { OkButtonText = "Evet", CancelButtonText = "Hayır" });
        if (isConfirm != true)
            return;

        IsLoading = true;

        var result = await UserService.DeleteAsync(((ODataUser)SelectedItem).Id);
        if (!result.Success)
            NotificationService.Error(result.Message);
        else
        {
            NotificationService.Success(result.Message);
            DialogService.Close(DialogResult.Refresh);
            Refresh();
        }

        IsLoading = false;
    }
}
