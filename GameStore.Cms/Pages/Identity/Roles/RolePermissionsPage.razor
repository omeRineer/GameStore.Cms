@inherits BaseDialog
@inject RoleService RoleService
@inject RoleODataService RoleODataService
@inject PermissionODataService PermissionODataService

<AuthorizeArea Policy="@Policies.Identity">
    <div class="row">
        <div class="col-md-9">
            <RadzenListBox FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                           FilterOperator="StringFilterOperator.Contains"
                           AllowFiltering="true"
                           @bind-Value=@SetRolePermissionsModel.Permissions
                           TextProperty="Key"
                           ValueProperty="Id"
                           Data="@Permissions"
                           Multiple=true
                           AllowClear=true
                           Placeholder="Arama"
                           Style="width: 100%; height:400px" />

        </div>
        <div class="col-md-3">
            <RadzenButton Text="Kaydet" Click="async args=> await SetRolePermissionsAsync()" Style="margin-bottom: 10px; width: 100%" Visible="@(IsLoading == false)" />
        </div>
    </div>
</AuthorizeArea>


@code {
    [Parameter] public ODataRole Role { get; set; }

    IEnumerable<ODataPermission>? Permissions;
    SetRolePermissionsModel SetRolePermissionsModel = new SetRolePermissionsModel();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        var rolePermissionsResult = await RoleService.GetPermissionsAsync(Role.Id);
        if (rolePermissionsResult.Data != null)
            SetRolePermissionsModel.Permissions = rolePermissionsResult.Data.Permissions;

        var permissionsResult = await PermissionODataService.GetListAsync(new ODataRequestParams { });
        if (permissionsResult.Value != null)
            Permissions = permissionsResult.Value.OrderByDescending(o => SetRolePermissionsModel?.Permissions?.Contains(o.Id)); ;

        SetRolePermissionsModel.RoleId = Role.Id;

        IsLoading = false;
    }

    async Task SetRolePermissionsAsync()
    {
        IsLoading = true;

        var result = await RoleService.SetPermissionsAsync(SetRolePermissionsModel);

        if (!result.Success)
            NotificationService.Error(result.Message);
        else
        {
            NotificationService.Success(result.Message);
            DialogService.Close(true);
        }

        IsLoading = false;
    }
}
